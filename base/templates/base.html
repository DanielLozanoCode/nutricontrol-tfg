{% load static i18n %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}{% trans "Nutricontrol" %}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; min-height: 100vh; }

    .navbar-container {
        background-color: #0070dd; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky; top: 0; left: 0; right: 0; z-index: 1000; 
    }
    .main-navbar-content { 
        max-width: 1200px; margin: 0 auto; padding: 0 20px; height: 60px; 
        display: flex; align-items: center; justify-content: space-between; position: relative;
    }
    .main-navbar-left .logo { height: 45px; display: block; }
    
    .main-navbar-center { display: flex; gap: 0; height: 100%; }
    .nav-item { position: relative; display: flex; align-items: center; /* Para alinear link y botón flecha */ }
    
    .nav-item .nav-link { /* Enlace principal de navegación */
        color: white; text-decoration: none; padding: 0 10px; /* Padding solo para el texto */
        font-weight: bold; font-size: 0.9em; 
        transition: background-color 0.2s ease;
        display: flex; align-items: center; height: 100%;
        border-radius: 4px 0 0 4px; /* Redondear lado izquierdo */
    }
    .nav-item .nav-link:hover,
    .nav-item .nav-link.active { 
        background-color: #005bb5; 
    }
    /* Si el desplegable está abierto, el enlace principal podría o no cambiar */
    .nav-item.dropdown-open > .nav-link {
         background-color: #005bb5; /* Mismo color que el hover/active */
    }


    .dropdown-toggle-button { /* Botón específico para la flecha */
        color: white;
        padding: 0 10px; /* Padding para el área de la flecha */
        height: 100%;
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-left: -1px; /* Para que el borde se solape o esté muy junto */
        border-radius: 0 4px 4px 0; /* Redondear lado derecho */
        transition: background-color 0.2s ease;
    }
    .nav-item:hover .dropdown-toggle-button, /* Para que el hover conjunto se vea bien */
    .nav-item.dropdown-open .dropdown-toggle-button {
         background-color: #005bb5; 
    }
    .dropdown-arrow { 
        font-size: 0.8em; /* Tamaño de la flecha */
        transition: transform 0.2s ease-out; 
        display: inline-block; 
    }
    .nav-item.dropdown-open .dropdown-toggle-button .dropdown-arrow { transform: rotate(180deg); }

    .dropdown-menu {
        display: none; position: absolute; top: 60px; /* Altura de la navbar */
        left: 0; background-color: #005bb5; 
        border-radius: 0 0 6px 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        min-width: 220px; list-style: none; padding: 8px 0; margin: 0;
        z-index: 1001; 
    }
    .nav-item.dropdown-open .dropdown-menu { display: block; }
    .dropdown-menu li a {
        display: block; padding: 10px 20px; color: #f0f0f0; 
        text-decoration: none; font-size: 0.85em; white-space: nowrap; 
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .dropdown-menu li a:hover { background-color: #0070dd; color: white; }

    .main-navbar-right { display: flex; align-items: center; gap: 10px; }
    .main-navbar-right .nav-button, .main-navbar-right .btn-logout { /* Estilos para botones de Login/Logout/Registro */
        color: white; text-decoration: none; padding: 7px 14px; 
        border-radius: 4px; font-weight: bold; background: none; 
        border: 1px solid white; font-size: 0.85em; cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .main-navbar-right .nav-button:hover, .main-navbar-right .btn-logout:hover { background-color: white; color: #0070dd; }
    .main-navbar-right .btn-register { background-color: #005bb5; border-color: #005bb5; }
    .main-navbar-right .btn-register:hover { background-color: white; color: #005bb5; }
    .logout-form-inline { display: inline; }

    .menu-toggle { 
        display: none; flex-direction: column; justify-content: space-around;
        width: 30px; height: 24px; background: transparent; border: none;
        cursor: pointer; padding: 0; z-index: 1005; position: relative;
    }
    .bar { display: block; width: 100%; height: 3px; background-color: white; border-radius: 2px; transition: all 0.3s ease-in-out; position: absolute; left: 0; }
    .bar:nth-child(1) { top: 0px; }
    .bar:nth-child(2) { top: 50%; transform: translateY(-50%); }
    .bar:nth-child(3) { bottom: 0px; }
    .menu-toggle.open .bar:nth-child(1) { top: 50%; transform: translateY(-50%) rotate(45deg); }
    .menu-toggle.open .bar:nth-child(2) { opacity: 0; }
    .menu-toggle.open .bar:nth-child(3) { top: 50%; transform: translateY(-50%) rotate(-45deg); }

    .mobile-side-menu { 
        display: flex; flex-direction: column; align-items: flex-start; 
        position: fixed; top: 0; right: -280px; 
        width: 280px; height: 100vh; background-color: #005bb5; 
        padding-top: 0; box-shadow: -2px 0 5px rgba(0,0,0,0.2); 
        transition: right 0.3s ease-in-out; 
        z-index: 1002; overflow-y: auto;
    }
    .mobile-side-menu.active { right: 0; }
    .mobile-side-menu-content-wrapper { padding-top: 60px; width: 100%; display: flex; flex-direction: column; }
    .mobile-side-menu a, .mobile-side-menu .logout-form-mobile button {
        padding: 15px 20px; width: 100%; text-align: left;
        border-bottom: 1px solid #0070dd; color: white; font-weight: bold; 
        text-decoration: none; background: none; 
        border-left: none; border-right: none; border-top: none;
        font-size: 1em; cursor: pointer; display: block;
    }
    .mobile-side-menu a:hover, .mobile-side-menu .logout-form-mobile button:hover { background-color: #007fe0; }
    .mobile-side-menu .logout-form-mobile { width: 100%; padding: 0; margin: 0; }
    .mobile-side-menu > .mobile-side-menu-content-wrapper > *:last-child,
    .mobile-side-menu > .mobile-side-menu-content-wrapper > div:last-child > form > button { border-bottom: none; }
    
    .mobile-dropdown-items a {
        padding-left: 35px !important; font-size: 0.9em !important;
        font-weight: normal !important; border-bottom-style: dashed !important;
        border-color: rgba(0, 112, 221, 0.5) !important;
    }
    .mobile-dropdown-items a:last-child { border-bottom: 1px solid #0070dd !important; }
    .mobile-side-menu > .mobile-side-menu-content-wrapper > .mobile-dropdown-items:last-child > a:last-child {
        border-bottom: none !important;
    }
    
    .main-content-area { padding: 20px; flex-grow: 1; }

    @media (max-width: 768px) {
        .main-navbar { position: fixed; top: 0; left: 0; right: 0; width:100%; background-color: #0070dd; z-index: 1003; }
        .main-navbar-content { background-color: transparent; justify-content: space-between; height: 60px; }
        .main-navbar-center, .main-navbar-right { display: none; }
        .menu-toggle { display: flex; } 
        .nav-item .dropdown-menu { display: none !important; } 
        .main-content-area { padding-top: calc(60px + 20px); }
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
<div class="navbar-container"> 
    <div class="main-navbar">
        <div class="main-navbar-content">
            <div class="main-navbar-left">
                <a href="{% url 'dashboard' %}">
                    <img src="{% static 'base/NutriControlLogo.png' %}" alt="{% trans 'Nutricontrol' %}" class="logo">
                </a>
            </div>
            <div class="main-navbar-center" id="desktopNavLinks">
                
                <div class="nav-item" id="nav-dashboard-item">
                    <a href="{% url 'dashboard' %}" class="nav-link"> {% trans "MI PÁGINA DE INICIO" %} 
                    </a>
                    {# Solo mostrar el botón de flecha y el menú si hay items en el desplegable Y el usuario está autenticado #}
                    {% if user.is_authenticated %} {# Podrías añadir and block.super para verificar si el bloque tiene contenido, pero es complejo #}
                    <span class="dropdown-toggle-button"> {# Botón separado para el desplegable #}
                        <span class="dropdown-arrow">&#9662;</span>
                    </span>
                    <ul class="dropdown-menu">
                        {% block dashboard_dropdown_items %}{% endblock dashboard_dropdown_items %}
                    </ul>
                    {% endif %}
                </div>

                <div class="nav-item" id="nav-alimentos-item">
                    <a href="{% url 'registro_alimentacion' %}" class="nav-link">{% trans "ALIMENTOS" %}</a>
                    {% if user.is_authenticated %}
                    <span class="dropdown-toggle-button">
                        <span class="dropdown-arrow">&#9662;</span>
                    </span>
                    <ul class="dropdown-menu">
                        {% block alimentos_dropdown_items %}
                            <li><a href="#">{% trans "Base de Datos (Alim.)" %}</a></li> {# Ejemplo #}
                        {% endblock alimentos_dropdown_items %}
                    </ul>
                    {% endif %}
                </div>
                <div class="nav-item" id="nav-ejercicio-item">
                    <a href="{% url 'ver_ejercicios' %}" class="nav-link">{% trans "EJERCICIO" %}</a>
                     {% if user.is_authenticated %}
                    <span class="dropdown-toggle-button">
                        <span class="dropdown-arrow">&#9662;</span>
                    </span>
                    <ul class="dropdown-menu">
                        {% block ejercicio_dropdown_items %}
                             <li><a href="#">{% trans "Base de Datos (Ejer.)" %}</a></li> {# Ejemplo #}
                        {% endblock ejercicio_dropdown_items %}
                    </ul>
                    {% endif %}
                </div>
                <div class="nav-item" id="nav-informes-item">
                    <a href="{% url 'lista_registros' %}" class="nav-link">{% trans "INFORMES" %}</a>
                    {% if user.is_authenticated %}
                    <span class="dropdown-toggle-button">
                        <span class="dropdown-arrow">&#9662;</span>
                    </span>
                    <ul class="dropdown-menu">
                        {% block informes_dropdown_items %}
                            <li><a href="#">{% trans "Resumen Semanal" %}</a></li> {# Ejemplo #}
                        {% endblock informes_dropdown_items %}
                    </ul>
                    {% endif %}
                </div>

            </div>
            <div class="main-navbar-right">
                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'logout' %}" class="logout-form-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn-logout">{% trans "CERRAR SESIÓN" %}</button>
                    </form>
                {% else %}
                    <a href="{% url 'login' %}" class="nav-button btn-login">{% trans "INICIAR SESIÓN" %}</a>
                    <a href="{% url 'registration_welcome' %}" class="nav-button btn-register">{% trans "REGISTRARSE" %}</a>
                {% endif %}
            </div>
            <div class="menu-toggle" id="menuToggle"> 
                <div class="bar"></div> <div class="bar"></div> <div class="bar"></div>
            </div>
        </div>
    </div>

    <div class="mobile-side-menu" id="navbarMenu"> 
        <div class="mobile-side-menu-content-wrapper">
            <a href="{% url 'dashboard' %}">{% trans "MI PÁGINA DE INICIO" %}</a>
            {% if user.is_authenticated %}<div class="mobile-dropdown-items">{% block mobile_dashboard_dropdown_items %}{% endblock %}</div>{% endif %}
            
            <a href="{% url 'registro_alimentacion' %}">{% trans "ALIMENTOS" %}</a>
            {% if user.is_authenticated %}<div class="mobile-dropdown-items">{% block mobile_alimentos_dropdown_items %}{% endblock %}</div>{% endif %}

            <a href="{% url 'ver_ejercicios' %}">{% trans "EJERCICIO" %}</a>
            {% if user.is_authenticated %}<div class="mobile-dropdown-items">{% block mobile_ejercicio_dropdown_items %}{% endblock %}</div>{% endif %}

            <a href="{% url 'lista_registros' %}">{% trans "INFORMES" %}</a>
            {% if user.is_authenticated %}<div class="mobile-dropdown-items">{% block mobile_informes_dropdown_items %}{% endblock %}</div>{% endif %}

            <hr style="border-color: #0070dd; margin: 10px 20px;"> 
            {% if user.is_authenticated %}
                <div class="logout-form-mobile"> 
                    <form method="post" action="{% url 'logout' %}" style="margin:0;">
                        {% csrf_token %}
                        <button type="submit">{% trans "CERRAR SESIÓN" %}</button>
                    </form>
                </div>
            {% else %}
                <a href="{% url 'login' %}">{% trans "INICIAR SESIÓN" %}</a>
                <a href="{% url 'registration_welcome' %}">{% trans "REGISTRARSE" %}</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="main-content-area">
  {% block content %}{% endblock %}
</div>

{% block extra_script %}{% endblock %}

<script>
    // --- Lógica para Menú Lateral Móvil ---
    const mobileMenu = document.getElementById('navbarMenu');
    const menuToggleButton = document.getElementById('menuToggle'); 

    function toggleMobileMenu() { 
        if (menuToggleButton) menuToggleButton.classList.toggle('open');
        if (mobileMenu) mobileMenu.classList.toggle('active');
    }

    if (menuToggleButton) {
        menuToggleButton.addEventListener('click', function(event) {
            event.stopPropagation(); 
            toggleMobileMenu();
        });
    }

    const mobileMenuLinks = document.querySelectorAll('.mobile-side-menu a, .mobile-side-menu form button');
    mobileMenuLinks.forEach(linkOrButton => {
        linkOrButton.addEventListener('click', function(event) {
            // console.log('Clic en (menú lateral):', this.tagName, this.href || 'Botón de formulario');
        });
    });

    // --- JavaScript para los Desplegables de la Navbar Principal (Escritorio) ---
    document.querySelectorAll('.nav-item .dropdown-toggle-button').forEach(toggleButton => {
        toggleButton.addEventListener('click', function(event) {
            event.stopPropagation(); // Previene que el clic se propague al listener del document

            const parentNavItem = this.closest('.nav-item');
            if (parentNavItem) {
                const isCurrentlyOpen = parentNavItem.classList.contains('dropdown-open');
                
                // Cerrar todos los OTROS desplegables
                document.querySelectorAll('.nav-item.dropdown-open').forEach(openDropdown => {
                    if (openDropdown !== parentNavItem) {
                        openDropdown.classList.remove('dropdown-open');
                    }
                });

                // Alternar el estado del desplegable actual
                if (isCurrentlyOpen) {
                    parentNavItem.classList.remove('dropdown-open');
                } else {
                    parentNavItem.classList.add('dropdown-open');
                }
            }
        });
    });

    // Cerrar desplegables si se hace clic fuera de ellos
    document.addEventListener('click', function(event) {
        const openDropdowns = document.querySelectorAll('.nav-item.dropdown-open');
        
        openDropdowns.forEach(dropdownContainer => {
            // Cerrar si el clic fue FUERA del .nav-item que contiene este desplegable
            if (!dropdownContainer.contains(event.target)) {
                dropdownContainer.classList.remove('dropdown-open');
            }
        });
    });

    function cambiarIdioma(lang) {
        alert("{% trans 'Esta función aún no está implementada.' %} " + lang);
    }
</script>

<footer style="background-color: #f8f8f8; padding: 40px 20px; text-align: center; font-size: 14px; color: #333;">
  <div style="max-width: 1000px; margin: auto;">
    <div style="display: flex; flex-wrap: wrap; justify-content: space-around; margin-bottom: 20px;">
      <div><h4>{% trans "Acerca de" %}</h4><p><a href="#">{% trans "Sobre NutriControl" %}</a></p><p><a href="#">{% trans "Contacto" %}</a></p></div>
      <div><h4>{% trans "Recursos" %}</h4><p><a href="#">{% trans "Educación nutricional" %}</a></p><p><a href="#">{% trans "Consejos saludables" %}</a></p></div>
      <div><h4>{% trans "Legal" %}</h4><p><a href="#">{% trans "Términos y condiciones" %}</a></p><p><a href="#">{% trans "Política de privacidad" %}</a></p></div>
      <div><h4>{% trans "Idioma" %}</h4><select onchange="cambiarIdioma(this.value)"><option value="es">Español</option><option value="en">English</option></select></div>
    </div>
    <p>© {% now "Y" %} NutriControl. {% trans "Proyecto académico desarrollado con fines educativos." %}</p>
  </div>
</footer>

</body>
</html>